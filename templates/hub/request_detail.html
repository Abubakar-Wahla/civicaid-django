{% extends "base.html" %}
{% block title %}CivicAid ¬∑ Request{% endblock %}

{% block content %}
  <a class="muted" href="{% url 'requests_list' %}">‚Üê Back to requests</a>

  <div style="margin-top:.8rem;" class="card">

    <h1 style="font-size:1.6rem; line-height:1.1;">
      {{ item.title }}
    </h1>

    <p class="muted" style="margin-top:.35rem;">
      {{ item.city }} ¬∑ {{ item.category.name }}
    </p>

    <div style="margin-top:.6rem; display:flex; gap:.4rem; flex-wrap:wrap;">
      <span class="pill">{{ item.get_status_display }}</span>
      <span class="pill">Urgency: {{ item.get_urgency_display }}</span>
    </div>

    <p style="margin-top:1rem; font-size:.95rem; color:#d1d5db;">
      {{ item.description }}
    </p>

    <p class="muted" style="margin-top:.8rem; font-size:.8rem;">
      Created by <strong>{{ item.owner.username }}</strong> ¬∑
      {{ item.created|date:"M d, Y" }}
    </p>

    <!-- Actions Section -->
    <div style="margin-top:1rem; display:flex; gap:.6rem; flex-wrap:wrap; align-items:center;">

      {% if request.user.is_authenticated and request.user == item.owner %}
        <a class="btn btn-primary" href="{% url 'update_request' item.id %}">Edit</a>
        <a class="btn btn-ghost" href="{% url 'delete_request' item.id %}">Delete</a>
      {% endif %}

      {% if request.user.is_authenticated %}
        {% if item.status == "OPEN" and request.user != item.owner %}
          <a class="btn btn-primary" href="{% url 'claim_request' item.id %}">
            Claim Request
          </a>
        {% endif %}

        {% if item.status == "IN_PROGRESS" and item.assigned_to == request.user %}
          <a class="btn btn-primary" href="{% url 'complete_request' item.id %}">
            Mark Completed
          </a>
        {% endif %}
      {% endif %}

      {% if request.user.is_authenticated %}
        {% if request.user == item.owner or request.user == item.assigned_to %}
          <a class="btn btn-ghost" href="{% url 'add_update' item.id %}">
            Post Update
          </a>
        {% endif %}
      {% endif %}

    </div>

    <!-- Status Info -->
    <div style="margin-top:.9rem;">
      <p class="muted" style="font-size:.82rem; margin:0;">
        Status:
        <strong style="color:var(--text);">
          {{ item.get_status_display }}
        </strong>

        {% if item.assigned_to %}
          ¬∑ Claimed by
          <strong style="color:var(--text);">
            {{ item.assigned_to.username }}
          </strong>
        {% endif %}
      </p>
    </div>

  </div>

  <!-- Updates Timeline -->
  <div style="margin-top:1.2rem;" class="card">
    <h3 style="font-size:1rem; margin-bottom:.6rem;">Updates</h3>

    {% if item.updates.all %}
      <div class="timeline">
        {% for u in item.updates.all %}
          <div class="timeline-item">
            <div class="timeline-head">
              <span class="pill">{{ u.author.username }}</span>
              <span class="muted" style="font-size:.78rem;">
                {{ u.created|date:"M d, Y ¬∑ H:i" }}
              </span>
            </div>
            <p class="timeline-msg">{{ u.message }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted" style="margin:0;">No updates yet.</p>
    {% endif %}
  </div>

  <!-- üîπ Matching Volunteers Section -->
  <section style="margin-top:1.2rem;">
    <div class="home-section-head">
      <div>
        <h2 class="home-h2">Matching volunteers</h2>
        <p class="home-p">Based on city and category.</p>
      </div>
      <a class="btn btn-ghost" href="{% url 'offers_list' %}">View all</a>
    </div>

    <div class="mini-vol-grid">
      {% for v in matches %}
        <article class="mini-vol-card">
          <div class="mini-vol-top">
            <div class="mini-vol-name">
              <a class="vol-link" href="{% url 'volunteer_detail' v.id %}">
                {{ v.full_name|default:v.user.username }}
              </a>
            </div>
            <span class="pill">{{ v.city|default:"‚Äî" }}</span>
          </div>

          <div class="mini-vol-tags">
            {% for c in v.categories.all %}
              <span class="tag">{{ c.name }}</span>
            {% empty %}
              <span class="tag">General</span>
            {% endfor %}
          </div>

          <div class="mini-vol-actions">
            <a class="btn btn-ghost" href="{% url 'volunteer_detail' v.id %}">View</a>

            {% if request.user.is_authenticated %}
              <a class="btn btn-primary" href="{% url 'contact' %}">Invite</a>
            {% else %}
              <a class="btn btn-primary"
                 href="{% url 'login' %}?next={% url 'request_detail' item.id %}">
                Login to invite
              </a>
            {% endif %}
          </div>
        </article>
      {% empty %}
        <div class="form-card">
          <h3 style="margin:0 0 .3rem;">No matches yet</h3>
          <p style="margin:0;color:var(--muted);">
            Check volunteers directory or create a volunteer profile.
          </p>
          <div style="margin-top:.8rem;">
            <a class="btn btn-ghost" href="{% url 'offers_list' %}">Browse volunteers</a>
          </div>
        </div>
      {% endfor %}
    </div>
  </section>

{% endblock %}
